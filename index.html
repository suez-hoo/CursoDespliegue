<!DOCTYPE html>
<html lang="en">
<head>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-SgOJa3DmI69IUzQ2PVdRZhwQ+dy64/BUtbMJw1MZ8t5HZApcHrRKUc4W0kG879m7" crossorigin="anonymous">
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.5/dist/js/bootstrap.bundle.min.js" integrity="sha384-k6d4wzSIapyDyv1kpU366/PK5hCdSbCRGRCMv+eplOQJWyd1fbcAu9OCUj5zNLiq" crossorigin="anonymous"></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplicación</title>
</head>
<body>
    <h1>Hola!</h1>
    <button onclick="finder()" class="btn btn-primary">Finder</button>
    <div id="resultados">TU DEA</div>
</body>
<script>
    const url = "https://apiscm.comunidad.madrid/t/ciudadanos.comunidad.madrid/sector-publico/catalogo-unificado/v1/recursos/94756e35-3059-451d-81a6-3427d2551de4/datos?distintos=true&formato=objects&$init=0&$limit=100";
    /**
     * Crea una tabla HTML con información de DEAs
     * @param {Array} deaData - Array con datos de DEAs
     * @param {string} containerId - ID del elemento donde insertar la tabla
     */
    function crearTablaDEAs(deaData, containerId = "resultados") {
        // Obtener el contenedor donde se insertará la tabla
        const container = document.getElementById(containerId);
        
        // Crear estructura de la tabla
        const table = document.createElement('table');
        table.className = 'table table-striped table-hover';
        
        // Crear encabezado
        const thead = document.createElement('thead');
        thead.className = 'table-dark';
        const headerRow = document.createElement('tr');
        
        // Definir columnas
        const columns = [
            'Código DEA', 
            'Latitud', 
            'Longitud', 
            'Ubicación', 
            'Distancia (m)'
        ];
        
        // Crear celdas de encabezado
        columns.forEach(column => {
            const th = document.createElement('th');
            th.textContent = column;
            headerRow.appendChild(th);
        });
        
        thead.appendChild(headerRow);
        table.appendChild(thead);
        
        // Crear cuerpo de la tabla
        const tbody = document.createElement('tbody');
        
        const arrayDea = deaData; // Asignar los datos de DEAs a arrayDea

        // Añadir filas con datos
        deaData.forEach(item => {
            const row = document.createElement('tr');
            
            // Crear celdas con datos
            const codigo = document.createElement('td');
            codigo.textContent = item.codigo_dea;
            
            const latitud = document.createElement('td');
            latitud.textContent = item.direccion_latitud.toFixed(6);
            
            const longitud = document.createElement('td');
            longitud.textContent = item.direccion_longitud.toFixed(6);
            
            const ubicacion = document.createElement('td');
            ubicacion.textContent = item.direccion_ubicacion;
            
            const distancia = document.createElement('td');
            distancia.textContent = Math.round(item.distance).toLocaleString();
            
            // Añadir celdas a la fila
            row.appendChild(codigo);
            row.appendChild(latitud);
            row.appendChild(longitud);
            row.appendChild(ubicacion);
            row.appendChild(distancia);
            
            // Añadir fila al cuerpo de la tabla
            tbody.appendChild(row);
        });
        
        table.appendChild(tbody);
        
        // Limpiar el contenedor y añadir la tabla
        container.innerHTML = '';
        container.appendChild(table);
    }

    const finder = () => {
        window.navigator.geolocation.getCurrentPosition(async(gp) => {
            try {
                let lat = gp.coords.latitude;
                let lon = gp.coords.longitude;
                
                document.querySelector("#resultados").innerHTML = "Buscando DEAs cercanos...";
                
                const res = await fetch(`https://cors-anywhere.herokuapp.com/https://deamadrid.com/api/finder?lat=${lat}&lon=${lon}`, {
                    method: "GET"
                });
                
                if (!res.ok) {
                    throw new Error(`Error en la respuesta: ${res.status}`);
                }
                
                const data = await res.json();
                console.log("Datos recibidos:", data);
                
                // Verificar estructura de datos
                if (!Array.isArray(data.data)) {
                    if (data && Array.isArray(data.data)) {
                        // Si los datos están en un campo 'results'
                        crearTablaDEAs(data.data, "resultados");
                    } else {
                        throw new Error("Formato de datos inesperado");
                    }
                } else {
                    crearTablaDEAs(data.data, "resultados");
                }
                
            } catch (error) {
                console.error("Error:", error);
                document.querySelector("#resultados").innerHTML = "Error al buscar DEAs: " + error.message;
            }
        }, (error) => {
            console.error("Error de geolocalización:", error);
            document.querySelector("#resultados").innerHTML = "Error: No se pudo acceder a tu ubicación";
        });
    }
</script>
</html>